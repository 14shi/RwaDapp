const MODE = (typeof secrets !== 'undefined' && secrets.ENVIRONMENT) ? secrets.ENVIRONMENT : "test"; const API_CONFIG = { test: { spotify: { verify: "https: }, patent: { verify: "https: }, gpu: { verify: "mock" } }, production: { spotify: { verify: "https: }, patent: { verify: "https: }, gpu: { verify: "https: } } }; function log(message) { if (MODE === "test") { console.log(`[VerifyAsset] ${message}`); } } function parseArgs(args) { let assetType = args[0]; const assetTypeMap = { "Spotify": 0, "spotify": 0, "Patent": 1, "patent": 1, "GPU": 2, "gpu": 2 }; if (typeof assetType === 'string' && assetTypeMap[assetType] !== undefined) { assetType = assetTypeMap[assetType]; } else { assetType = parseInt(assetType); } const externalId = args[1]; const ownerProof = args[2]; log(`Parsed args - assetType: ${assetType}, externalId: ${externalId}, ownerProof: ${ownerProof}`); return { assetType, externalId, ownerProof }; } async function verifySpotify(externalId, ownerProof) { const config = API_CONFIG[MODE].spotify; if (MODE === "test") { log(`Testing Spotify verification for ID: ${externalId}`); try { const response = await Functions.makeHttpRequest({ url: `${config.verify}/${externalId}`, method: "GET" }); if (response.error) { log(`API Error: ${response.error}`); return false; } const username = response.data.username; const isValid = username.toLowerCase() === ownerProof.toLowerCase(); log(`Verification result: ${isValid} (username: ${username})`); return isValid; } catch (error) { log(`Exception: ${error.message}`); return false; } } else { log(`Production Spotify verification for track: ${externalId}`); try { const response = await Functions.makeHttpRequest({ url: `${config.verify}/${externalId}`, method: "GET", headers: { "Authorization": secrets.SPOTIFY_API_TOKEN } }); if (response.error) { log(`Spotify API Error: ${response.error}`); return false; } const artists = response.data.artists || []; const isValid = artists.some(artist => artist.name.toLowerCase() === ownerProof.toLowerCase() ); log(`Verification result: ${isValid}`); return isValid; } catch (error) { log(`Exception: ${error.message}`); return false; } } } async function verifyPatent(externalId, ownerProof) { const config = API_CONFIG[MODE].patent; if (MODE === "test") { log(`Testing Patent verification for ID: ${externalId}`); try { const response = await Functions.makeHttpRequest({ url: config.verify, method: "GET" }); if (response.error) { log(`API Error: ${response.error}`); return false; } const isValid = parseInt(externalId) % 2 === 0; log(`Verification result: ${isValid} (mock logic)`); return isValid; } catch (error) { log(`Exception: ${error.message}`); return false; } } else { log(`Production Patent verification for number: ${externalId}`); try { const response = await Functions.makeHttpRequest({ url: `${config.verify}/${externalId}`, method: "GET", headers: { "X-API-Key": secrets.USPTO_API_KEY } }); if (response.error) { log(`USPTO API Error: ${response.error}`); return false; } const inventors = response.data.inventors || []; const isValid = inventors.some(inventor => inventor.name.toLowerCase().includes(ownerProof.toLowerCase()) ); log(`Verification result: ${isValid}`); return isValid; } catch (error) { log(`Exception: ${error.message}`); return false; } } } async function verifyGPU(externalId, ownerProof) { const config = API_CONFIG[MODE].gpu; if (MODE === "test") { log(`Testing GPU verification for serial: ${externalId}`); const isValid = externalId.length > 5 && ownerProof.includes("@"); log(`Verification result: ${isValid} (mock logic)`); return isValid; } else { log(`Production GPU verification for serial: ${externalId}`); try { const response = await Functions.makeHttpRequest({ url: `${config.verify}/verify`, method: "POST", headers: { "X-API-Key": secrets.GPU_API_KEY, "Content-Type": "application/json" }, data: { serialNumber: externalId, ownerEmail: ownerProof } }); if (response.error) { log(`GPU API Error: ${response.error}`); return false; } const isValid = response.data.verified === true; log(`Verification result: ${isValid}`); return isValid; } catch (error) { log(`Exception: ${error.message}`); return false; } } } async function verifyAsset(assetType, externalId, ownerProof) { log(`Starting verification - Type: ${assetType}, ID: ${externalId}, Mode: ${MODE}`); let isValid = false; switch (parseInt(assetType)) { case 0: isValid = await verifySpotify(externalId, ownerProof); break; case 1: isValid = await verifyPatent(externalId, ownerProof); break; case 2: isValid = await verifyGPU(externalId, ownerProof); break; default: log(`Unknown asset type: ${assetType}`); isValid = false; } return isValid; } const { assetType, externalId, ownerProof } = parseArgs(args); const isValid = await verifyAsset(assetType, externalId, ownerProof); const result = isValid ? 1 : 0; log(`Final result: ${result}`); return Functions.encodeUint256(result);